# Story 2.2: Implement Intra-Topic Page Navigation

## Status: Functionally Complete pending Full Integration & Final AC Review

## Story

- As the Archival System,
- I want to, for each given Topic ID, reliably identify and navigate to all of its internal pages (e.g., page 1, 2, 3... up to the last page of that specific thread),
- So that I can systematically provide the URL for each individual page of a topic to the HTML download module.

## Acceptance Criteria (ACs)

*This story directly implements Functional Requirement 2.2 from the PRD. The ACs are derived from the PRD and typical requirements for robust page navigation.*

1.  **AC1:** Given a Topic ID (and ideally its base URL from the Topic Index from Story 2.1), the system MUST determine the URL for the first page of that topic.
2.  **AC2:** The system MUST be able to fetch and parse the content of a topic page to identify pagination controls or indicators (e.g., "Next Page" links, page number links, or total page count information).
3.  **AC3:** The system MUST correctly identify the URL for each subsequent page within the topic, sequentially.
4.  **AC4:** The system MUST accurately determine when it has reached the last page of a topic (e.g., no "Next Page" link, current page number matches total page count).
5.  **AC5:** The system MUST collect and return an ordered list of URLs, representing all pages of the given topic, from the first page to the last.
6.  **AC6:** The system MUST be resilient to common variations in forum pagination HTML structure (within reasonable limits of The Magic Cafe's typical design).
7.  **AC7:** The system MUST implement robust error handling for scenarios such as:
    *   Network errors when fetching a page to check for pagination.
    *   Inability to find or parse pagination information on a page.
    *   Unexpected HTML structure breaking pagination logic.
8.  **AC8:** If a topic is found to have only one page, the system MUST correctly return only the URL for that single page.
9.  **AC9:** The system SHOULD apply politeness delays (as configured in Story 2.5) when fetching topic pages for pagination analysis to avoid stressing the server, even if these are HEAD requests or lightweight GETs.
10. **AC10:** The system MUST log its activity, including the Topic ID being processed, the number of pages found, and any errors encountered during pagination discovery.
11. **AC11:** The output (list of page URLs) for a given Topic ID MUST be available in a format easily consumable by the HTML download module (Story 2.3).

## Tasks / Subtasks

- [x] Task 1: Design Topic Page URL Construction (AC: 1, 3)
    - [x] Subtask 1.1: Define how to construct the URL for page 1 of a topic given its ID/base URL.
    - [x] Subtask 1.2: Research Magic Cafe URL structure for subsequent pages (e.g., `&page=2`).
- [x] Task 2: Implement Page Fetching and Parsing for Pagination (AC: 2, 6, 7, 9)
    - [x] Subtask 2.1: Implement function to fetch a topic page.
    - [x] Subtask 2.2: Implement HTML parsing logic (using `goquery` or similar) to find "Next Page" links.
    - [x] Subtask 2.3: Implement error handling for fetch/parse failures.
    - [~] Subtask 2.4: Integrate politeness delay (AC9) - Mechanism in place, full CLI integration pending Story 2.5/2.8.
- [x] Task 3: Implement Pagination Logic (AC: 3, 4, 5, 8)
    - [x] Subtask 3.1: Develop loop/recursion to navigate from one page to the next.
    - [x] Subtask 3.2: Implement logic to detect the last page.
    - [x] Subtask 3.3: Store collected page URLs in order.
    - [x] Subtask 3.4: Handle single-page topics correctly.
- [x] Task 4: Integration and Output (AC: 11)
    - [x] Subtask 4.1: Define the output data structure for the list of page URLs (now `[]PageNavigationInfo`).
    - [x] Subtask 4.2: Ensure the module can be easily called with a Topic ID (accepts `data.Topic`).
- [x] Task 5: Logging (AC: 10)
    - [x] Subtask 5.1: Add logging for Topic ID processing, pages found, errors.
- [x] Task 6: Unit Testing
    - [x] Subtask 6.1: Write unit tests for URL construction.
    - [x] Subtask 6.2: Write unit tests for page parsing logic (with mock HTML).
    - [x] Subtask 6.3: Write unit tests for pagination logic (single page, multi-page, error cases).

## Dev Technical Guidance

- This module will likely be a Go package (e.g., `internal/archiver/navigation` or `pkg/navigation`). Implemented in `internal/indexer/navigation`.
- Input: A struct or data representing a single topic (from Story 2.1's output), including at least Topic ID and its base URL.
- Output: A slice of strings (URLs) or a slice of structs containing URL and page number.
- The HTML parsing should be targeted. It's not full content extraction, just enough to find pagination elements.
- Consider how The Magic Cafe indicates the total number of pages or the link to the "next" page. This might involve inspecting the HTML of actual topic pages.
- Example Topic URL: `https://www.themagiccafe.com/forums/viewtopic.php?topic_id={TOPIC_ID}`
- Example Paginated URL: `https://www.themagiccafe.com/forums/viewtopic.php?topic_id={TOPIC_ID}&page={PAGE_NUM}` (This needs verification - current implementation uses `start=N` based on `ParsePaginationLinks`, but `GetTopicPageURLs` is simpler and just looks for `Next` for now. The `page` parameter is common for topics.)

## Story Progress Notes

### Agent Model Used: Gemini 2.5 Pro (via BMad IDE Orchestrator)

### Completion Notes List
- Implemented `GetTopicPageURLs` in `internal/indexer/navigation/navigation.go` for intra-topic pagination.
- Input changed to `data.Topic` and output changed to `[]PageNavigationInfo`.
- Logging added for key events, errors, and progress.
- `FetchHTML` function was made mockable and now includes a mechanism to honor a `time.Duration` politeness delay. `GetTopicPageURLs` accepts this delay.
- Unit tests updated and passing for implemented functionality.
- **AC6 (Pagination Resilience):** Current implementation relies on "Next" links. Advanced parsing for page numbers or other indicators is a potential future enhancement if this proves insufficient.
- **AC9 (Politeness Delay Integration):** The core mechanism is in place in `navigation.go` and `config.go`. Full CLI flag parsing in a main executable and passing the configured delay through the application call stack to `GetTopicPageURLs` will be completed as part of Story 2.5/2.8. The `cmd/indexer/main.go` (from Epic 1) has been updated to correctly call the modified `FetchHTML` with its own delay config.

### Change Log
- 2025-05-26: Initial draft created by BMad IDE Orchestrator.
- 2025-05-26: Implemented core topic page navigation logic (`GetTopicPageURLs`) and associated unit tests.
- 2025-05-26: Updated `GetTopicPageURLs` input/output, added logging.
- 2025-05-26: Incorporated politeness delay mechanism into `FetchHTML` and `GetTopicPageURLs`. Updated `pkg/config`. Updated Story 2.3 with a note.
- 2025-05-26: Corrected linter errors in `cmd/indexer/main.go` related to `FetchHTML` signature change. Story status updated.

---
## Story Draft Checklist Review (2025-05-26)

**Review of Story 2.2: Implement Intra-Topic Page Navigation**

**1. GOAL & CONTEXT CLARITY**
*   [x] Story goal/purpose is clearly stated
*   [x] Relationship to epic goals is evident (Part of Epic 2: Raw HTML Archival)
*   [x] How the story fits into overall system flow is explained (Provides page URLs to download module)
*   [x] Dependencies on previous stories are identified (Story 2.1 for Topic ID/base URL, Story 2.5 for politeness delays)
*   [x] Business context and value are clear (Essential for archiving all pages of a topic)

**2. TECHNICAL IMPLEMENTATION GUIDANCE**
*   [x] Key files to create/modify are identified (Go package `internal/archiver/navigation` or `pkg/navigation` suggested)
*   [x] Technologies specifically needed for this story are mentioned (Go, `goquery` or similar for HTML parsing)
*   [x] Critical APIs or interfaces are sufficiently described (Input: Topic data; Output: list of page URLs)
*   [x] Necessary data models or structures are referenced (Input struct from Story 2.1, output as slice of strings/structs)
*   [ ] Required environment variables are listed (N/A for this story, politeness config from Story 2.5 is separate) - *Marked as N/A as explicit env vars are not defined for this specific story, but relies on config from another.*
*   [x] Any exceptions to standard coding patterns are noted (N/A)

**3. REFERENCE EFFECTIVENESS**
*   [x] References to external documents point to specific relevant sections (PRD FR 2.2 mentioned)
*   [x] Critical information from previous stories is summarized (Input from 2.1, politeness from 2.5)
*   [x] Context is provided for why references are relevant
*   [x] References use consistent format (N/A for direct refs in this story to specific sections yet) - *Marked N/A as no new specific doc sections referenced yet.*

**4. SELF-CONTAINMENT ASSESSMENT**
*   [x] Core information needed is included
*   [x] Implicit assumptions are made explicit (URL structure needs verification)
*   [x] Domain-specific terms or concepts are explained (Topic ID, pagination)
*   [x] Edge cases or error scenarios are addressed (Network errors, parsing errors, single-page topics)

**5. TESTING GUIDANCE**
*   [x] Required testing approach is outlined (Unit testing)
*   [x] Key test scenarios are identified (URL construction, parsing, pagination logic for various cases)
*   [x] Success criteria are defined (Implicitly by ACs)
*   [x] Special testing considerations are noted (Mock HTML for parsing tests)

**VALIDATION RESULT**

| Category                             | Status | Issues |
| :----------------------------------- | :----- | :----- |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   | Minor: Env vars N/A clarification. Relies on Story 2.5 config. |
| 3. Reference Effectiveness           | PASS   | Minor: No new specific doc sections referenced *within* this story's text yet. |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:**
- READY: The story provides sufficient context for implementation. The minor points in Tech Guidance and Reference Effectiveness are informational and do not block development. The placeholder for Agent Model and YYYY-MM-DD in changelog and review date should be updated by the implementing agent.

--- 